{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Budgie{% endblock %}

{% block extra_css %}
<link href="{% static 'css/secondary_apps.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-container">
   <h1 class="dashboard-title">Dashboard</h1>

   <!-- Wrap everything in the same width container -->
   <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem; width: 100%; max-width: 1344px;">

       <!-- Dashboard Cards -->
       <div class="dashboard-cards" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; justify-content: center !important; margin: 0 auto !important;">
           <!-- Total Expenses Card -->
           <div class="dashboard-card">
               <div class="card-title">Total Expenses</div>
               <div class="card-amount">{{ user_currency }}{{ monthly_expenses|floatformat:0|default:"0" }}</div>
               <div class="card-subtitle">
                   {% if show_yearly_overview %}
               this year
           {% else %}
               this month
           {% endif %}
               </div>
               <a href="{% url 'add_expense' %}" class="add-category-btn">Add Expense</a>
           </div>

           <!-- Remaining Budget Card -->
           <div class="dashboard-card">
               <div class="card-title">Remaining Budget</div>
               <div class="budget-info">
                   <div class="budget-text">
                       {% if budget_amount %}
                           {% if is_over_budget %}
                               <div class="card-amount" style="color: #ff4444;">-{{ user_currency }}{{ budget_remaining|floatformat:0 }}</div>
                               <div class="card-subtitle" style="color: #ff4444;">of {{ user_currency }}{{ budget_amount|floatformat:0 }} ({{ budget_percentage|floatformat:0 }}% over)</div>
                           {% else %}
                               <div class="card-amount" style="color: #4A931C;">{{ user_currency }}{{ budget_remaining|floatformat:0 }}</div>
                               <div class="card-subtitle">of {{ user_currency }}{{ budget_amount|floatformat:0 }} ({{ budget_percentage|floatformat:0 }}%)</div>
                           {% endif %}
                           <a href="{% url 'set_budget' %}" class="add-category-btn">Set Budget</a>
                       {% else %}
                           <div class="card-amount">No Budget Set</div>
                           <a href="{% url 'set_budget' %}" class="add-category-btn">Set Budget</a>
                       {% endif %}
                   </div>

                  {% if budget_amount %}
           <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient({% if is_over_budget %}#ff4444{% else %}#4A931C{% endif %} 0deg {% widthratio budget_percentage 1 3.6 %}deg, #e0e0e0 {% widthratio budget_percentage 1 3.6 %}deg 360deg); display: flex; align-items: center; justify-content: center;">
               <div style="width: 60px; height: 60px; background: white; border-radius: 50%;"></div>
           </div>
           {% endif %}
               </div>
           </div>

           <!-- Subscriptions Card -->
           <div class="dashboard-card">
               <div class="card-title">Subscriptions</div>
               <div class="card-amount">{{ user_currency }}{{ subscription_total|floatformat:0 }}</div>
               <div class="card-subtitle">
                   {% if show_yearly_overview %}
               this year
           {% else %}
               this month
           {% endif %}
               </div>
               <a href="{% url 'add_subscription' %}" class="add-category-btn">Add Subscription</a>
           </div>
       </div>

       <!-- Report Generation Section -->
       <div class="report-section" style="margin-bottom: 3rem;">
           <form method="POST" action="{% url 'generate_report' %}">
               {% csrf_token %}

               <!-- Dropdowns on first line -->
               <div style="display: flex; gap: 20px; margin-bottom: 24px;">
                   <select name="report_type" style="height: 48px; padding: 14px 16px; border: 1px solid #1B221B; border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 14px;">
                       <option value="monthly_summary">Monthly Financial Summary</option>
                       <option value="yearly_overview">Annual Financial Overview</option>
                   </select>

                   <select name="month" style="height: 48px; padding: 14px 16px; border: 1px solid #1B221B; border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 14px;">
                       <option value="1" {% if current_month == 1 %}selected{% endif %}>January</option>
                       <option value="2" {% if current_month == 2 %}selected{% endif %}>February</option>
                       <option value="3" {% if current_month == 3 %}selected{% endif %}>March</option>
                       <option value="4" {% if current_month == 4 %}selected{% endif %}>April</option>
                       <option value="5" {% if current_month == 5 %}selected{% endif %}>May</option>
                       <option value="6" {% if current_month == 6 %}selected{% endif %}>June</option>
                       <option value="7" {% if current_month == 7 %}selected{% endif %}>July</option>
                       <option value="8" {% if current_month == 8 %}selected{% endif %}>August</option>
                       <option value="9" {% if current_month == 9 %}selected{% endif %}>September</option>
                       <option value="10" {% if current_month == 10 %}selected{% endif %}>October</option>
                       <option value="11" {% if current_month == 11 %}selected{% endif %}>November</option>
                       <option value="12" {% if current_month == 12 %}selected{% endif %}>December</option>
                   </select>

                   <select name="year" style="height: 48px; padding: 14px 16px; border: 1px solid #1B221B; border-radius: 8px; font-family: 'Roboto Mono', monospace; font-size: 14px;">
                       <option value="2023" {% if current_year == 2023 %}selected{% endif %}>2023</option>
                       <option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
                       <option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
                   </select>
               </div>

               <!-- Buttons on second line -->
               <div style="display: flex; gap: 20px;">
                   {% if request.GET.report_id %}
                       <a href="{% url 'main_dashboard' %}" class="add-category-btn">‚Üê Back to Dashboard</a>
                   {% endif %}
                   <button type="submit" class="add-category-btn">Generate Report</button>
               </div>
           </form>
       </div>

       <!-- Recent Expenses Section -->
       <div class="recent-expenses-section" style="border-radius: 16px !important; overflow: hidden !important;">
          <div class="section-header">
              <h2 class="section-title">Recent Expenses</h2>
              <a href="{% url 'expenses_dashboard' %}" class="add-category-btn" style="margin-top: 38px !important;">View All</a>
          </div>

          <!-- Simple message when no expenses -->
          {% if not recent_expenses %}
              <p style="text-align: center; color: #666; padding: 1rem;">
                  {% if show_monthly_summary %}No expenses for {{ period_start|date:"F Y" }}{% elif show_yearly_overview %}No expenses for {{ period_start.year }}{% else %}No expenses yet{% endif %}
              </p>
          {% endif %}

          <table class="expenses-table">
              <thead>
                  <tr style="border-radius: 16px 16px 0 0;">
                      <th>Date</th>
                      <th>Category</th>
                      <th>Description</th>
                      <th>Amount</th>
                      <th></th>
                  </tr>
              </thead>
              <tbody>
                  {% for expense in recent_expenses %}
                  <tr>
                      <td>{{ expense.date|date:"M d, Y" }}</td>
                      <td>{{ expense.category.name }}</td>
                      <td>{{ expense.description }}</td>
                      <td>{{ user_currency }}{{ expense.amount|floatformat:2 }}</td>
                      <td>
                          <a href="{% url 'edit_expense' expense.id %}" class="btn-edit">Edit</a>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
       </div>

   </div> <!-- Close the wrapper div -->
</div>
{% endblock %}